---
title: 内存池系列｜tcmalloc如何管理内存
---

基本要求：
对抗内存碎片、在多核处理器能够 scale

内部碎片是已经被分配出去（能明确指出属于哪个进程）的内存空间大于请求所需的内存空间，不能被利用的内存空间就是内部碎片。

外部碎片是指还没有分配出去（不属于任何进程），但是由于大小而无法分配给申请内存空间的新进程的内存空闲块。

#### 如何分配定长记录？

最大化内存使用率，最小化分配时间

bitmap来管理定长记录
内存使用率：bitmap需要额外内存，有一定浪费
时间分配效率：$O(1)$

FreeList来管理定长记录
内存使用率：100%
时间分配效率：$O(1)$

#### 如何分配变长记录？

变长记录进行“取整”操作
带来了内存碎片问题，我们只能减少，而无可避免。
为了减少内部碎片，分配规则按照 8, 16, 32, 48, 64, 80，并非2的幂次级

FreeList来管理“取整”之后的定长记录
内存使用率：有一定的内存碎片
时间分配效率：$O(1)$

以上分配方式都是基于page，当分配小于page的对象时会使用。

---

#### 大的对象如何分配

首先，每一个线程有一块ThreadCache来管理从CentralCache分配的内存

由于ThreadLocal，所以从ThreadCache分配内存不需要加锁。

CentralCache通过page以及span来管理内存，当需要分配内存时，会通过spinlock来加锁保护。

span关键属性：是否空闲、startPageId, pageNum
page关键属性：是否空闲

通过Buddy系统来管理所有空闲的page,而分配出去的Page通过RadixTree来管理起来。

通过RadixTree管理有两个好处：
（1）节省内存，按需分配
（2）查询性能也还不错，等价于树高度

memcache如何管理内存

slab allcator的机制

![memcache内存分配示意图](http://cdn.b5mang.com/2021320115717.png)

