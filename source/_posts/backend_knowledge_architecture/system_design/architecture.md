---
title: 系统架构
date: 2021-01-19 23:23:03
updated:
mathjax: true
categories:
- [系统设计]
tags: 
---

## 高并发系统的三个目标与挑战

高并发是一个系统的**挑战**

如何衡量一个系统的并发有多高呢？ 同时在线人数

高性能、高可用、可扩展是一个牛B系统**目标**

### 如何衡量一个吞吐量有多大呢？

    系统的QPS，吞吐量 = 并发进程数 / 响应时间

### 如何衡量一个系统的性能有多高呢？   
    
    接口响应时间，分位耗时

### 如何衡量一个系统的可用性有多高呢？  
    
    平均故障间隔，平均故障恢复时间

![不同可用性标准下允许的故障时间](http://cdn.b5mang.com/202132011926.png)

### 如何衡量一个系统的可扩展能力？

    通过增加进程来应对更高的并发。

### 高性能

提高吞吐量：

1. 增加并发进程数

注意：无限增加，不会无限提升性能(对系统的扩展性有要求)

![性能拐点模型](http://cdn.b5mang.com/202132011337.png)

2. 减少响应时间

IO密集型：优化数据库索引、加缓存

CPU密集型：优化算法时间复杂度、减少不必要运算等

### 高可用

plan挂了之后，系统能不能活下来？ 有没有负责兜底的PlanB。

感觉一下提高1个9，难度有多大：

三个9: 非核心业务可以容忍

四个9: 核心业务

运维值班体系、业务变更流程、故障处理流程、更加完善的系统故障排查工具

五个9: 必须让机器来自动处理恢复！

两个方面来提高系统可用性：

（1）系统设计-尽量思考故障发生后应该怎么办

考虑点：如何自动的发现故障、如何自动化的应对故障

具体方法：failover(故障转移)、超时控制、服务降级、熔断限流

failover:

- 完全对等
- 非完全对等（例如存在主备节点，心跳，选择paxos, raft等）

超时控制

全局超时控制

服务降级（区分核心流程与非核心流程）

限流

熔断

（2）系统运维-尽量避免故障发生

灰度发布（确保服务可回滚）

故障演练

### 可扩展

数据库、缓存、依赖的第三方、复杂均衡、交换机带宽都是系统扩展时需要考虑的点

数据库：按照业务拆分、分库分表

业务层：按照业务拆分、按照重要性拆分（核心、非核心）、按照请求来源（客户端、web、内网等）

分层的原因：本质上是为了让系统有更好的可扩展能力。

![架构分层](http://cdn.b5mang.com/2021320104242.png)

manager层：

1. 抽象service层可能提供的一些原子能力
2. 封装对第三方接口的调用
 
## 高准确系统，遇上高并发

高准确，也就是高一致性，例如秒杀系统中会遇到的库存问题。

## 如何应对系统的挑战

架构通用原则：“4 要 1 不要”

(1) 数据要尽量少

- 用户请求的数据能少就少
- 系统依赖的数据能少就少

(2) 请求数要尽量少

例如，静态文件合并

（3）路径要尽量短

将强依赖的服务进行单机部署

（4）依赖要尽量少

系统服务分级，高等级服务尽量少依赖低等级服务

（5）不要有单点

服务无状态，可扩展；存储层做副本备份

---

我觉得作为一个程序员，你首先**需要从高维度出发，从整体上思考问题**。

在我看来，秒杀（其实不只是秒杀，所有的高难度系统）其实主要解决两个问题，一个是**并发读**，一个是**并发写**。

并发读的核心优化理念是尽量减少用户到服务端来“读”数据，或者让他们读更少的数据；

并发写的处理原则也一样，它要求我们在数据库层面独立出来一个库，做特殊的处理。

另外，我们还要针对秒杀系统做一些保护，针对意料之外的情况设计兜底方案，以防止最坏的情况发生。

而从一个架构师的角度来看，要想打造并维护一个超大流量并发读写、高性能、高可用的系统，在整个用户请求路径上从浏览器到服务端我们要遵循几个原则，就是要保证用户请求的数据尽量少、请求数尽量少、路径尽量短、依赖尽量少，并且不要有单点。

两个大的方向：提升单次效率、减少不必要的请求

1. 动静分离方案
2. 热点的发现与隔离
3. 请求的削峰与分层过滤（异步化）
4. 服务端的极致优化（缓存）


如何在满足一个良好架构的分布式系统基础上，针对秒杀这种业务做到极致的性能改进

池化技术
核心思想：用空间换时间，期望使用预先创建好的对象来减少频繁创建对象的性能开销，同时还统一管理了对象，降低了对象的使用成本。
例子：
（1）数据库连接池-最小数量、最大数量、如果超过最大则等待
（2）线程池-最小数量、最大数量、有界队列（监控队列中元素的个数）
线程池大小：区分IO密集、CPU密集
（3）内存池

![JDK线程池提交任务示意图](http://cdn.b5mang.com/2021320121239.png)

池子的初始化

---

项目经历的思考

技术方案设计思路，排查线上问题的能力，以及对于项目架构演进方向的把握。

服务指标：qps, 缓存命中率

引导到你的强项？

技术难点？

诡异的地方，难查的地方？排查思路

排查rpc框架bug? 有那些疑难咋整？

cpu 某些cpu 100%？

strace 跟踪系统调用 top netstat